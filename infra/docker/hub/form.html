<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
    <title>JupyterLab Server Options</title>
    <style>
        label { display: block; margin-top: 1em; font-weight: bold; }
        select, input { width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ccc; }
        fieldset { border: 1px solid #ccc; border-radius: 6px; padding: 10px; }
        legend { font-weight: bold; padding: 0 5px; }
        .start, .form-actions,
        button[type="submit"].start,
        .submit-button,
        .feedback-container {
            display: none !important;
        }
        .center-button {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .start-button {
            background-color: #f97316;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }
        .start-button:hover {
            background-color: #ea580c;
        }
        .info-message {
            background-color: #e4f2ff;
            border: 1px solid #b3d7ff;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
        }
        .gpu-option {
            color: #15803d;
            font-weight: bold;
        }
        .cpu-option {
            color: #0369a1;
        }
        .loading {
            text-align: center;
            margin: 20px 0;
            font-style: italic;
            color: #666;
        }
        .node-info {
            margin-top: 5px;
            font-size: 0.9em;
            color: #666;
        }
    </style>
    <script>
        window.onload = async function () {
            await loadNodes();

            const defaultBtn = document.querySelector('.feedback-container');
            if (defaultBtn) {
                defaultBtn.remove();
            }

            // Add image selection info display
            const imageSelect = document.getElementById("image-select");
            const imageInfo = document.getElementById("image-info");

            imageSelect.addEventListener("change", function() {
                updateImageInfo(imageSelect.value);
            });

            // Initialize with default selection
            updateImageInfo(imageSelect.value);
        };

        function updateImageInfo(imageValue) {
            const imageInfo = document.getElementById("image-info");
            const nodeNote = document.getElementById("node-selection-note");

            if (imageValue.includes("gpu") || imageValue.includes("cu") || imageValue.includes("tf") || imageValue.includes("rpl")) {
                imageInfo.innerHTML = "<strong>GPU Image Selected:</strong> This image will request GPU resources";
                imageInfo.className = "info-message gpu-info";

                // Update node selection note
                nodeNote.innerHTML = "ðŸŸ¢ GPU node will be selected automatically.";
            } else {
                imageInfo.innerHTML = "<strong>CPU Image Selected:</strong> This image will use only CPU resources";
                imageInfo.className = "info-message cpu-info";

                // Update node selection note
                nodeNote.innerHTML = "âšª CPU node will be selected automatically.";
            }
        }

        async function loadNodes() {
            const select = document.getElementById("node-select");
            const nodeInfo = document.getElementById("node-info");

            select.innerHTML = "<option disabled selected>Loading nodes...</option>";
            nodeInfo.innerHTML = "<div class='loading'>Fetching available nodes...</div>";

            try {
                // const res = await fetch("/hub/api/available-nodes");
                const res = await fetch("http://172.18.0.4:15002/available-nodes");
                const nodes = await res.json();

                if (nodes.length === 0) {
                    select.innerHTML = "<option disabled>No nodes available</option>";
                    nodeInfo.innerHTML = "<div class='info-message'>No nodes are currently available. Please contact an administrator.</div>";
                    return;
                }

                select.innerHTML = "<option value=''>-- Select a Node --</option>";

                // Sort nodes: GPU nodes first, then by hostname
                nodes.sort((a, b) => {
                    if (a.has_gpu && !b.has_gpu) return -1;
                    if (!a.has_gpu && b.has_gpu) return 1;
                    return a.hostname.localeCompare(b.hostname);
                });

                for (const node of nodes) {
                    const hostname = node.hostname || "unknown";
                    const gpu = node.has_gpu ? "ðŸŸ¢ GPU" : "âšª CPU";
                    const cpu = parseFloat(node.cpu_usage_percent || 0).toFixed(1);
                    const ramUsed = parseFloat(node.memory_used_gb || 0).toFixed(1);
                    const ramTotal = parseFloat(node.memory_total_gb || 0).toFixed(1);
                    const ram = `${ramUsed}/${ramTotal}GB`;

                    const opt = document.createElement("option");
                    opt.value = hostname;

                    // Add class for styling
                    if (node.has_gpu) {
                        opt.className = "gpu-option";
                    } else {
                        opt.className = "cpu-option";
                    }

                    opt.innerText = `${hostname} - ${gpu} | CPU: ${cpu}% | RAM: ${ram}`;
                    select.appendChild(opt);
                }

                // Update info text
                nodeInfo.innerHTML = `<div class='node-info'>Found ${nodes.length} available nodes. GPU nodes are highlighted in green.</div>`;

                // Add change event to show details
                select.addEventListener("change", function() {
                    if (this.value) {
                        const selectedNode = nodes.find(n => n.hostname === this.value);
                        if (selectedNode) {
                            const gpuInfo = selectedNode.has_gpu ? "Has GPU" : "No GPU";
                            nodeInfo.innerHTML = `<div class='node-info'>
                                <strong>Selected:</strong> ${selectedNode.hostname}<br>
                                <strong>Resources:</strong> ${gpuInfo} | CPU: ${parseFloat(selectedNode.cpu_usage_percent || 0).toFixed(1)}% |
                                RAM: ${parseFloat(selectedNode.memory_used_gb || 0).toFixed(1)}/${parseFloat(selectedNode.memory_total_gb || 0).toFixed(1)}GB
                            </div>`;
                        }
                    } else {
                        nodeInfo.innerHTML = `<div class='node-info'>Please select a node to continue</div>`;
                    }
                });

            } catch (e) {
                select.innerHTML = `<option disabled>Error fetching node list</option>`;
                nodeInfo.innerHTML = "<div class='info-message'>Failed to load available nodes. Please try refreshing the page or contact an administrator.</div>";
                console.error("Node fetch failed:", e);
            }
        }
    </script>
</head>
<body>
    <form action="{{ url }}" method="post">
        <fieldset>
            <legend>JupyterLab Server Configuration</legend>

            <!-- <label for="node">Select Node:</label>
            <select name="node" id="node-select" required>
                <option disabled selected>Loading...</option>
            </select>
            <div id="node-info" class="node-info"></div> -->

            <label for="node">Selected Node:</label>
            <div id="node-selection-note" class="info-message">Node will be selected automatically based on the image.</div>

            <label for="image">Docker Image:</label>
            <select name="image" id="image-select" required>
                <option value="danielcristh0/jupyterlab:cpu" class="cpu-option">JupyterLab CPU</option>
                <option value="danielcristh0/jupyterlab:rpl" class="gpu-option">JupyterLab GPU (PyTorch)</option>
                <option value="danielcristh0/jupyterlab:cu121" class="gpu-option">JupyterLab CUDA 12.1</option>
                <option value="danielcristh0/jupyterlab:tf" class="gpu-option">JupyterLab TensorFlow</option>
            </select>
            <div id="image-info" class="info-message"></div>

            <div class="center-button">
                <button type="submit" class="start-button">
                    Start JupyterLab Server
                </button>
            </div>
        </fieldset>
    </form>
</body>
</html>