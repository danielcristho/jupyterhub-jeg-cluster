<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <!-- <title>JupyterLab Server Options</title> -->
  <style>
    label { display: block; margin-top: 1em; font-weight: bold; }
    select, input { width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ccc; }
    fieldset { border: 1px solid #ccc; border-radius: 6px; padding: 10px; }
    legend { font-weight: bold; padding: 0 5px; }
    .center-button { display: flex; justify-content: center; margin-top: 20px; }
    .start-button {
      background-color: #f97316;
      color: white;
      padding: 12px 36px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
    }
    .start-button:hover { background-color: #ea580c; }
    .info-message, .success-message, .warning-message, .error-message {
      border-radius: 4px;
      padding: 10px;
      margin: 10px 0;
      font-size: 14px;
    }
    .info-message { background-color: #e4f2ff; border: 1px solid #b3d7ff; }
    .success-message { background-color: #d1fae5; border: 1px solid #86efac; color: #065f46; }
    .warning-message { background-color: #fef3c7; border: 1px solid #fcd34d; color: #92400e; }
    .error-message { background-color: #fee2e2; border: 1px solid #fca5a5; color: #991b1b; }
    .loading { text-align: center; margin: 20px 0; font-style: italic; color: #666; }
    .node-status { margin-top: 10px; padding: 8px; font-size: 0.9em; }
    .debug-info {
      margin-top: 15px;
      padding: 10px;
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.8em;
    }
  </style>
  <script>
    let availableNodes = [];

    const DISCOVERY_API_URL = "http://192.168.100.246:15002";

    window.onload = async function () {
      await checkApiStatus();
      await loadNodes();

      const imageSelect = document.getElementById("image-select");
      imageSelect.addEventListener("change", function () {
        updateImageInfo(imageSelect.value);
        updateNodeSelection(imageSelect.value);
      });

      const allButtons = document.querySelectorAll("button");
      allButtons.forEach(btn => {
        if (btn.innerText.trim().toLowerCase() === "start") {
          btn.style.display = "none";
        }
      })

      // initial run
      updateImageInfo(imageSelect.value);
      updateNodeSelection(imageSelect.value);
    };

    async function checkApiStatus() {
      const statusDiv = document.getElementById("api-status");
      try {
        const res = await fetch(`${DISCOVERY_API_URL}/health-check`);
        const data = await res.json();
        statusDiv.innerHTML = `<div class='success-message'>
          ‚úì Discovery API Connected<br><small>${data.message}</small></div>`;
      } catch (e) {
        statusDiv.innerHTML = `<div class='error-message'>
          ‚úó Discovery API Unreachable<br><small>Error: ${e.message}</small></div>`;
      }
    }

    function updateImageInfo(imageValue) {
      const imageSelect = document.getElementById("image-select");
      const selectedOption = imageSelect.options[imageSelect.selectedIndex];
      const description = selectedOption.getAttribute("data-desc") || "No description available.";
      const isGpu = imageValue.toLowerCase().includes("gpu") ||
                    imageValue.toLowerCase().includes("cuda") ||
                    imageValue.toLowerCase().includes("tensorflow");

      const imageInfo = document.getElementById("image-info");
      imageInfo.innerHTML = `<strong>${isGpu ? "GPU Image" : "CPU Image"}:</strong> ${description}`;
      imageInfo.className = isGpu ? "info-message success-message" : "info-message";
    }

    function updateNodeSelection(imageValue) {
      const nodeStatus = document.getElementById("node-status");
      const useGpu = imageValue.toLowerCase().includes("gpu") ||
                     imageValue.toLowerCase().includes("cuda") ||
                     imageValue.toLowerCase().includes("tensorflow");

      if (availableNodes.length === 0) {
        nodeStatus.innerHTML = `<div class='warning-message'>No nodes data available. Please refresh the page.</div>`;
        return;
      }

      const suitableNodes = availableNodes.filter(node => useGpu ? node.has_gpu : true);
      if (suitableNodes.length === 0) {
        nodeStatus.innerHTML = `<div class='error-message'>
          No suitable nodes available for this image type.<br>
          ${useGpu ? 'No GPU nodes found. Try CPU image instead.' : 'No nodes available.'}
        </div>`;
        return;
      }

      const selectedNode = suitableNodes.reduce((best, current) =>
        (current.memory_usage_percent || 100) < (best.memory_usage_percent || 100) ? current : best
      );

      const gpuStatus = selectedNode.has_gpu ? "GPU" : "CPU";
      const cpuUsage = parseFloat(selectedNode.cpu_usage_percent || 0).toFixed(1);
      const memUsage = parseFloat(selectedNode.memory_usage_percent || 0).toFixed(1);
      const ramGb = parseFloat(selectedNode.ram_gb || 0).toFixed(1);
      const gpuDetail = selectedNode.gpu?.length > 0
        ? selectedNode.gpu.map(g => `${g.name} (${g.memory_used_mb}/${g.memory_total_mb}MB)`).join(", ")
        : "None";

      nodeStatus.innerHTML = `
        <div class='success-message node-status'>
          <strong>Auto-selected Node: ${selectedNode.hostname}</strong><br>
          ${gpuStatus} | CPU: ${cpuUsage}% of ${selectedNode.cpu} cores | RAM: ${memUsage}% of ${ramGb}GB<br>
          <strong>GPU:</strong> ${gpuDetail}<br>
          <small>IP: ${selectedNode.ip}</small><br>
          <small>Selected from ${suitableNodes.length} nodes</small>
        </div>
      `;

      document.getElementById("input-node").value = selectedNode.hostname;
      document.getElementById("input-node-ip").value = selectedNode.ip;
    }

    async function loadNodes() {
      const nodeStatus = document.getElementById("node-status");
      const summaryDiv = document.getElementById("nodes-summary");
      const debugDiv = document.getElementById("debug-info");

      nodeStatus.innerHTML = "<div class='loading'>üîÑ Checking available nodes...</div>";
      summaryDiv.innerHTML = "";
      debugDiv.style.display = "none";

      try {
        const res = await fetch(`${DISCOVERY_API_URL}/available-nodes`);
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);

        let nodes = await res.json();
        if (!Array.isArray(nodes) && Array.isArray(nodes.data)) {
          nodes = nodes.data;
        }

        if (!Array.isArray(nodes)) throw new Error("Invalid response format from API");

        availableNodes = nodes;

        if (availableNodes.length === 0) {
          nodeStatus.innerHTML = `<div class='warning-message'>‚ö†Ô∏è No nodes currently available.</div>`;
          return;
        }

        const gpuNodes = availableNodes.filter(n => n.has_gpu).length;
        summaryDiv.innerHTML = `<div class='info-message'>
          <strong>Available Resources:</strong> ${availableNodes.length} nodes
          (${gpuNodes} GPU, ${availableNodes.length - gpuNodes} CPU-only)
        </div>`;

        const imageSelect = document.getElementById("image-select");
        updateNodeSelection(imageSelect.value);

      } catch (e) {
        nodeStatus.innerHTML = `<div class='error-message'>Failed to load node info<br><small>${e.message}</small></div>`;
        debugDiv.style.display = "block";
        debugDiv.innerHTML = `<div class="debug-info"><strong>Debug:</strong><br>${e.message}</div>`;
      }
    }
  </script>
</head>
<body>
  <form action="{{ url }}" method="post">
    <fieldset>
      <!-- <legend>JupyterLab Server Configuration</legend> -->

      <div id="api-status"></div>
      <div id="nodes-summary"></div>

      <label for="image">Docker Image:</label>
      <select name="image" id="image-select" required>
        <option value="danielcristh0/jupyterlab:cpu" data-desc="CPU-only JupyterLab for basic tasks">danielcristh0/jupyterlab:cpu</option>
        <option value="danielcristh0/jupyterlab:gpu" data-desc="GPU-enabled JupyterLab with CUDA support">danielcristh0/jupyterlab:gpu</option>
        <option value="JupyterLab CUDA 12.1" data-desc="Optimized for CUDA 12.1 workloads">JupyterLab CUDA 12.1</option>
        <option value="JupyterLab TensorFlow" data-desc="TensorFlow pre-installed with GPU">JupyterLab TensorFlow</option>
      </select>
      <div id="image-info" class="info-message"></div>

      <label>Node Selection:</label>
      <div id="node-status" class="loading">Loading node information...</div>

      <input type="hidden" name="node" id="input-node" />
      <input type="hidden" name="node_ip" id="input-node-ip" />

      <div class="center-button">
        <button type="submit" class="start-button">Start JupyterLab Server</button>
      </div>

      <div id="debug-info" style="display: none;"></div>
    </fieldset>
  </form>
</body>
</html>
